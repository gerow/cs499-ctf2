#!/usr/bin/python

import urllib2
import time
import random
import sys
import Queue

BASE_PATH = "http://server/process.php?"

USERNAME_PARTS = ["user", "name"]

users = []

def sleep():
	time.sleep(1)

def urlopen(url):
	print "opening url: " + url
	print "response:"
	try:
	    print urllib2.urlopen(url, timeout=1.0).read()
	except Exception, e:
		print "exception thrown (not able to connect to server?)"
		print e
		sleep()
		return False
	sleep()
	return True

def add_random_account():
	namepart1 = random.choice(USERNAME_PARTS)
	namepart2 = random.choice(USERNAME_PARTS)
	number = random.randrange(0, 1000)
	name = namepart1 + namepart2 + str(number)
	password = str(random.randrange(0, 9817)) + "lkjw109ubs" + str(random.randrange(55, 97))
	user = {'user': name, 'pass': password}
	users.append(user)
	url = BASE_PATH + build_username_password_url(user) + "&drop=register"
	return urlopen(url)

def build_username_password_url(user):
	return "user=%s&pass=%s" % (user['user'], user['pass'])

def get_balance_history():
	user = random.choice(users)
	url = BASE_PATH + build_username_password_url(user) + "&drop=balance"
	return urlopen(url)

def make_deposit():
	user = random.choice(users)
	url = BASE_PATH + build_username_password_url(user) + ("&amount=%d&drop=deposit" % random.randrange(1, 100000))
	return urlopen(url)

def make_withdraw():
	user = random.choice(users)
	url = BASE_PATH + build_username_password_url(user) + ("&amount=%d&drop=withdraw" % random.randrange(1, 100000))
	return urlopen(url)

COMMANDS = [
  add_random_account,
  get_balance_history,
  make_deposit,
  make_withdraw
]

def execute_random_command():
	command = random.choice(COMMANDS)

def main():
	add_random_account()
	timeq = Queue.Queue(10)
	for i in xrange(10):
		timeq.put(time.time())
	while True:
		if random.choice(COMMANDS)():
			now = time.time()
			last = timeq.get()
			timeq.put(now)
			rps = 10.0 / (now - last)
			print "responses per second (last 10): " + str(rps)


main()